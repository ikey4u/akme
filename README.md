## Introduction

akme is an ACME client which help you issue/renew certificate from certificate
authority, it does only two things

- Issue HTTPS certificate
- Automatically renew HTTPS certificate (in daemonize)

And then you can integrate the certificate into your favorite web server.

## Usage

You must run akme in administrator/root priviledge since akme will listen on
port 80, see usage using `akme -h`.

Assume your `domain` is `exampmle.com` and your `ssldir` is `/etc/akme`, here is
an example configuration in nginx:

    server {
        listen 443 ssl;
        server_name example.com;

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_certificate /etc/akme/example.com.crt
        ssl_certificate_key /etc/akme/example.com.key;
    }

## TODO

- implement daemonize mode
- implement stop, test and log subcommand

## Development

The process is a bit cumbersome, so please be patient!

- Setup and start CA provisioner

    Install [step-ca](https://github.com/smallstep/certificates/releases) and
    [step-cli](https://github.com/smallstep/cli/releases), and use `step-cli` to
    init CA provisioner, see example below:

        $ step ca init --acme
        ✔ Deployment Type: Standalone
        What would you like to name your new PKI?
        ✔ (e.g. Smallstep): akme
        What DNS names or IP addresses will clients use to reach your CA?
        ✔ (e.g. ca.example.com[,10.1.2.3,etc.]): localhost
        What IP and port will your new CA bind to? (:443 will bind to 0.0.0.0:443)
        ✔ (e.g. :443 or 127.0.0.1:443): 127.0.0.1:4433
        What would you like to name the CA's first provisioner?
        ✔ (e.g. you@smallstep.com): akme@example.com
        Choose a password for your CA keys and first provisioner.
        ✔ [leave empty and we'll generate one]:
        ✔ Password: 1234567890

    Then start CA provisioner using `step-ca`:

        step-ca $(step path)/config/ca.json

    It will ask you the password, input the password you setup above
    (`1234567890`), then press enter and you are done.

- Edit `/etc/hosts`

    Open `/etc/hosts` in administrator or root priviledge, and add a domain entry
    of `example.com`

        127.0.0.1 example.com

    Now you can test if your host is fine with command

        cargo test --features dev-check-hosts  -- --nocapture

- Test CA issue

    Ensure you have your ca provisioner started, and then run the following
    command to test

        sudo ACME_ROOT_CA=<ACME_ROOT_CA> ACME_DIR_URL=<ACME_DIR_URL> cargo test --features dev-issue

    where ACME_ROOT_CA is your root ca generated by `step-ca` which will be
    found at

        $HOME/.step/certs/root_ca.crt

    and ACME_DIR_URL is acme directory which will be something like

        https://localhost:4433/acme/acme/directory

    for example

        export ACME_ROOT_CA=${HOME}/.step/certs/root_ca.crt
        export ACME_DIR_URL=https://localhost:4433/acme/acme/directory
        sudo -E cargo test --features dev-issue -- --nocapture

    The `sudo` is a required to run the test in priviledge since listening 80
    port requires that.
